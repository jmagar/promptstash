## Version 2025/11/03
# promptstash proxy configuration
# make sure that your dns has a cname set for promptstash

server {
    listen 443 ssl;
#    listen 443 quic;
    listen [::]:443 ssl;
#    listen [::]:443 quic;

    server_name promptstash.*;

    include /config/nginx/ssl.conf;

    client_max_body_size 0;

    # enable for Authelia (requires authelia-location.conf in the location block)
    include /config/nginx/authelia-server.conf;

    # Better Auth routes - proxy to Next.js on port 3100
    location /api/auth/ {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        set $upstream_app 100.122.19.93;
        set $upstream_port 3100;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    # CSRF token endpoint - proxy to Express server on port 3300
    location /api/csrf-token {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        set $upstream_app 100.122.19.93;
        set $upstream_port 3300;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    # PromptStash data API routes - proxy to Express server on port 3300
    location ~ ^/api/(stashes|files|folders|validate|tags|csrf-token) {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        set $upstream_app 100.122.19.93;
        set $upstream_port 3300;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    # Next.js HMR WebSocket - proxy to Next.js on port 3100
    location /_next/webpack-hmr {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        set $upstream_app 100.122.19.93;
        set $upstream_port 3100;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

        # WebSocket-specific buffering (proxy.conf already handles upgrade headers and timeouts)
        proxy_buffering off;
    }

    location / {
        # enable for Authelia (requires authelia-server.conf in the server block)
        include /config/nginx/authelia-location.conf;

        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        set $upstream_app 100.122.19.93;
        set $upstream_port 3100;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

    }
}
